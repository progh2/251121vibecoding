import streamlit as st
import pandas as pd
import plotly.express as px

# -----------------------------------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì • ë° ë””ìì¸
# -----------------------------------------------------------------------------
st.set_page_config(
    page_title="ê°œë°œì ì„±í–¥ í…ŒìŠ¤íŠ¸",
    page_icon="ğŸ’»",
    layout="wide"
)

st.title("ğŸš€ ì£¼ë‹ˆì–´ í”„ë¡œê·¸ë˜ë¨¸ë¥¼ ìœ„í•œ ì–¸ì–´ ì¶”ì²œê¸°")
st.markdown("""
> **"ë‹¹ì‹ ì˜ ì„±ê²©ì— ë”± ë§ëŠ” í”„ë¡œê·¸ë˜ë° ì–¸ì–´ëŠ” ë¬´ì—‡ì¼ê¹Œìš”?"** > í•™ìƒ ì—¬ëŸ¬ë¶„ì˜ MBTIë¥¼ ì„ íƒí•˜ë©´, ì°°ë–¡ê¶í•© ì–¸ì–´ë¥¼ ì¶”ì²œí•˜ê³  íŠ¸ë Œë“œ ë°ì´í„°ë¥¼ ë³´ì—¬ë“œë ¤ìš”! ğŸ“ğŸ“Š
""")
st.divider()

# -----------------------------------------------------------------------------
# 2. ë°ì´í„° ë¡œë“œ (Pandas)
# -----------------------------------------------------------------------------
@st.cache_data
def load_data():
    # CSV íŒŒì¼ì´ í˜„ì¬ í´ë”ì— ìˆë‹¤ê³  ê°€ì •
    file_path = 'Popularity_of_Programming_Languages_from_2004_to_2024.csv'
    df = pd.read_csv(file_path)
    # ë‚ ì§œ ì»¬ëŸ¼ì„ datetime í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    df['Date'] = pd.to_datetime(df['Date'])
    return df

try:
    df = load_data()
except FileNotFoundError:
    st.error("âš ï¸ CSV íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 'Popularity_of_Programming_Languages_from_2004_to_2024.csv' íŒŒì¼ì„ ê°™ì€ í´ë”ì— ë„£ì–´ì£¼ì„¸ìš”.")
    st.stop()

# -----------------------------------------------------------------------------
# 3. MBTIì™€ ì–¸ì–´ ë§¤í•‘ ë¡œì§
# -----------------------------------------------------------------------------
# CSVì˜ ì»¬ëŸ¼ëª…ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ ê·¸ë˜í”„ê°€ ê·¸ë ¤ì§‘ë‹ˆë‹¤.
mbti_mapping = {
    # ë¶„ì„ê°€í˜•
    "INTJ": {"lang": "Rust", "desc": "ì¹˜ë°€í•œ ì„¤ê³„ì™€ ì•ˆì •ì„±ì„ ì‚¬ë‘í•˜ëŠ” ì „ëµê°€! ğŸ—ï¸", "trait": "ì‹œìŠ¤í…œ í”„ë¡œê·¸ë˜ë°, ê³ ì„±ëŠ¥"},
    "INTP": {"lang": "Python", "desc": "ë…¼ë¦¬ì ì´ê³  í˜¸ê¸°ì‹¬ ë§ì€ ì‚¬ìƒ‰ê°€! ğŸ", "trait": "ë°ì´í„° ì‚¬ì´ì–¸ìŠ¤, AI, ë°±ì—”ë“œ"},
    "ENTJ": {"lang": "C/C++", "desc": "íš¨ìœ¨ì„±ì„ ê·¹ëŒ€í™”í•˜ëŠ” ëŒ€ë‹´í•œ í†µì†”ì! âš¡", "trait": "ê²Œì„ ì—”ì§„, ì„ë² ë””ë“œ, ê³ ì„±ëŠ¥ ì»´í“¨íŒ…"},
    "ENTP": {"lang": "JavaScript", "desc": "ìƒˆë¡œìš´ ê°€ëŠ¥ì„±ì„ íƒêµ¬í•˜ëŠ” ë°œëª…ê°€! ğŸŒ", "trait": "ì›¹ í”„ë¡ íŠ¸ì—”ë“œ/ë°±ì—”ë“œ, í’€ìŠ¤íƒ"},
    
    # ì™¸êµê´€í˜•
    "INFJ": {"lang": "Java", "desc": "ì‚¬ëŒì„ ë•ëŠ” ê¹Šì€ í†µì°°ë ¥ì˜ ì˜¹í˜¸ì! â˜•", "trait": "ëŒ€ê·œëª¨ ì—”í„°í”„ë¼ì´ì¦ˆ ì‹œìŠ¤í…œ, ì•ˆë“œë¡œì´ë“œ"},
    "INFP": {"lang": "Kotlin", "desc": "ìš°ì•„í•˜ê³  ê°„ê²°í•œ ì½”ë“œë¥¼ ê¿ˆê¾¸ëŠ” ì¤‘ì¬ì! ğŸ¨", "trait": "ëª¨ë˜ ì•ˆë“œë¡œì´ë“œ ì•±, ê°„ê²°í•œ ë¬¸ë²•"},
    "ENFJ": {"lang": "Swift", "desc": "ì‚¬ìš©ì ê²½í—˜ì„ ì¤‘ìš”ì‹œí•˜ëŠ” ì •ì˜ë¡œìš´ ì‚¬íšŒìš´ë™ê°€! ğŸ", "trait": "iOS ì•± ê°œë°œ, ì• í”Œ ìƒíƒœê³„"},
    "ENFP": {"lang": "Ruby", "desc": "ììœ ë¡­ê³  ì°½ì˜ì ì¸ í™œë™ê°€! ğŸ’", "trait": "ì›¹ ê°œë°œ(Rails), ë¹ ë¥¸ í”„ë¡œí† íƒ€ì´í•‘"},
    
    # ê´€ë¦¬ìí˜•
    "ISTJ": {"lang": "C#", "desc": "ì‚¬ì‹¤ì— ê·¼ê±°í•˜ì—¬ ì‚¬ê³ í•˜ëŠ” í˜„ì‹¤ì£¼ì˜ì! ğŸ¯", "trait": "ìœˆë„ìš° ì•±, ìœ ë‹ˆí‹° ê²Œì„ ê°œë°œ"},
    "ISFJ": {"lang": "PHP", "desc": "ê¾¸ì¤€í•˜ê³  ì„±ì‹¤í•˜ê²Œ ì›¹ì„ ì§€í‚¤ëŠ” ìˆ˜í˜¸ì! ğŸ˜", "trait": "ì›¹ ì„œë²„, ì›Œë“œí”„ë ˆìŠ¤"},
    "ESTJ": {"lang": "Go", "desc": "ì§ì„¤ì ì´ê³  íš¨ìœ¨ì ì¸ ì‚¬ì—…ê°€! ğŸ¹", "trait": "í´ë¼ìš°ë“œ ì‹œìŠ¤í…œ, ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤"},
    "ESFJ": {"lang": "TypeScript", "desc": "í˜‘ë ¥ì„ ì¤‘ìš”ì‹œí•˜ë©° ì‹¤ìˆ˜ë¥¼ ë°©ì§€í•˜ëŠ” ì¹œì„ ë„ëª¨í˜•! ğŸ›¡ï¸", "trait": "ëŒ€ê·œëª¨ ì›¹ í”„ë¡œì íŠ¸, ì•ˆì •ì„±"},
    
    # íƒí—˜ê°€í˜•
    "ISTP": {"lang": "C/C++", "desc": "ë„êµ¬ë¥¼ ëŠ¥ìˆ™í•˜ê²Œ ë‹¤ë£¨ëŠ” ë§ŒëŠ¥ ì¬ì£¼ê¾¼! ğŸ› ï¸", "trait": "í•˜ë“œì›¨ì–´ ì œì–´, ì„±ëŠ¥ ìµœì í™”"},
    "ISFP": {"lang": "Dart", "desc": "ì˜ˆìˆ ì  ê°ê°ì´ ë›°ì–´ë‚œ ëª¨í—˜ê°€! ğŸ¯", "trait": "í”ŒëŸ¬í„°(Flutter) í¬ë¡œìŠ¤ í”Œë«í¼ ì•±"},
    "ESTP": {"lang": "R", "desc": "ë°ì´í„°ë¥¼ í†µí•´ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ì‚¬ì—…ê°€! ğŸ“Š", "trait": "í†µê³„ ë¶„ì„, ë°ì´í„° ì‹œê°í™”"},
    "ESFP": {"lang": "Visual Basic", "desc": "ì¦‰ê°ì ì¸ ê²°ê³¼ì™€ ì‹¤ìš©ì„±ì„ ì¶”êµ¬í•˜ëŠ” ì—°ì˜ˆì¸! ğŸ¬", "trait": "ì˜¤í”¼ìŠ¤ ìë™í™”, ë ˆê±°ì‹œ ì‹œìŠ¤í…œ"}
}

# -----------------------------------------------------------------------------
# 4. ì‚¬ìš©ì ì…ë ¥ (ì‚¬ì´ë“œë°”)
# -----------------------------------------------------------------------------
with st.sidebar:
    st.header("ğŸ” ë‹¹ì‹ ì˜ ìœ í˜•ì€?")
    selected_mbti = st.selectbox(
        "MBTIë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”:",
        options=list(mbti_mapping.keys())
    )
    st.markdown("---")
    st.caption("ğŸ’¡ MBTIëŠ” ì¬ë¯¸ë¡œ ë³´ëŠ” ì„±í–¥ ë¶„ì„ì…ë‹ˆë‹¤.")

# -----------------------------------------------------------------------------
# 5. ë©”ì¸ ì»¨í…ì¸ : ì¶”ì²œ ê²°ê³¼ ë° ê·¸ë˜í”„
# -----------------------------------------------------------------------------
if selected_mbti:
    result = mbti_mapping[selected_mbti]
    lang_name = result["lang"]
    
    # 5-1. ì¶”ì²œ ì¹´ë“œ UI
    col1, col2 = st.columns([1, 2])
    
    with col1:
        st.info(f"**{selected_mbti}** ìœ í˜•ì´ì‹œêµ°ìš”!")
        st.markdown(f"### ì¶”ì²œ ì–¸ì–´: **{lang_name}**")
        st.write(f"{result['desc']}")
        st.write(f"âœ¨ **ì£¼ìš” íŠ¹ì§•:** {result['trait']}")
        
    with col2:
        # 5-2. Plotly ê·¸ë˜í”„ (ì„ íƒëœ ì–¸ì–´ì˜ ì¸ê¸°ë„ ë³€í™”)
        st.markdown(f"#### ğŸ“ˆ {lang_name} ì¸ê¸°ë„ ë³€í™” (2004-2024)")
        
        # ë°ì´í„°ì— í•´ë‹¹ ì–¸ì–´ ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸
        if lang_name in df.columns:
            fig = px.line(
                df, 
                x='Date', 
                y=lang_name,
                labels={'value': 'Popularity (%)', 'Date': 'Year'},
                template="plotly_white"
            )
            fig.update_traces(line_color='#FF4B4B', line_width=3) # ìŠ¤íŠ¸ë¦¼ë¦¿ ìƒ‰ìƒ í…Œë§ˆ
            st.plotly_chart(fig, use_container_width=True)
        else:
            st.warning(f"ë°ì´í„°ì…‹ì— {lang_name}ì— ëŒ€í•œ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.")

    st.divider()

    # -----------------------------------------------------------------------------
    # 6. ìš”ì•½ í…Œì´ë¸” (ìµœì‹  ë°ì´í„° ê¸°ì¤€)
    # -----------------------------------------------------------------------------
    st.subheader("ğŸ“Š í˜„ì¬ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ íŠ¸ë Œë“œ ìš”ì•½")
    
    # ê°€ì¥ ìµœì‹  ë‚ ì§œì˜ ë°ì´í„°ë§Œ ì¶”ì¶œ
    latest_date = df['Date'].max()
    latest_data = df[df['Date'] == latest_date].iloc[0]
    
    # ì‹œë¦¬ì¦ˆë¥¼ ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ë³€í™˜í•˜ê³  ì •ë ¬
    summary_df = pd.DataFrame({
        'Language': latest_data.index[1:], # Date ì œì™¸
        'Popularity (%)': latest_data.values[1:]
    })
    
    # ì¸ê¸°ë„ ìˆœìœ¼ë¡œ ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ)
    summary_df['Popularity (%)'] = pd.to_numeric(summary_df['Popularity (%)'])
    summary_df = summary_df.sort_values(by='Popularity (%)', ascending=False).reset_index(drop=True)
    
    # ìƒìœ„ 5ê°œë§Œ ê°•ì¡°, ë‚˜ë¨¸ì§€ëŠ” ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ
    top_col, table_col = st.columns([1, 2])
    
    with top_col:
        st.markdown(f"**ğŸ“… ê¸°ì¤€: {latest_date.strftime('%Yë…„ %mì›”')}**")
        st.write("ğŸ”¥ **Top 3 Languages**")
        for i in range(3):
            st.write(f"{i+1}. **{summary_df.iloc[i]['Language']}** ({summary_df.iloc[i]['Popularity (%)']}%)")
            
    with table_col:
        st.dataframe(
            summary_df, 
            column_config={
                "Popularity (%)": st.column_config.ProgressColumn(
                    "Popularity",
                    format="%.2f%%",
                    min_value=0,
                    max_value=30,
                )
            },
            hide_index=True,
            use_container_width=True
        )

    if st.button("ğŸ‰ ì¶”ì²œ ê²°ê³¼ê°€ ë§ˆìŒì— ë“œì‹œë‚˜ìš”?"):
        st.balloons()
